---
title: "Gene Enrichment Analysis"
date: today
embed-resources: true
execute: 
  echo: false
  warning: false
  messages: false
format: html
---


```{r}
# gprofiler2: Interface to g:Profiler for functional enrichment analysis
# https://biit.cs.ut.ee/gprofiler/gost
# https://cran.r-project.org/web/packages/gprofiler2/vignettes/gprofiler2.html
library(gprofiler2)

# fgsea: Fast Gene Set Enrichment Analysis
# https://bioconductor.org/packages/release/bioc/vignettes/fgsea/inst/doc/fgsea-tutorial.html
library(fgsea)

# msigdbr: Access to MSigDB gene sets for multiple species
library(msigdbr)

# Data manipulation and visualization
library(tidyverse)
library(kableExtra)
library(UpSetR)
```

To identify biological pathways and processes affected by Cre-mediated ApoE4→ApoE2 conversion in liver tissue, we performed complementary enrichment analyses using the high-confidence differentially expressed genes from Method 1 (combined batches, no batch adjustment).

## Liver

### Over-Representation Analysis (ORA)
```{r}
#| fig-width: 10
#| out-width: "100%"

# Load clean DEGs from method 1 for liver
# Sort by absolute fold change to prioritize genes with largest effect sizes
results_liver <- read_csv("data/clean_DEGs_liver_1.csv") |> 
  arrange(desc(abs(log2FoldChange)))

# Perform over-representation analysis using g:Profiler
# Tests whether DEGs are enriched in functional categories compared to background
gost_liver <- gost(
  query = results_liver$gene,           # List of significant DEGs
  organism = "mmusculus",                # Mouse
  ordered_query = TRUE,                  # Preserve gene ranking by fold change
  exclude_iea = FALSE,                   # Include electronically inferred annotations
  user_threshold = 0.05,                 # Significance threshold
  significant = TRUE,                    # Return only significant terms
  correction_method = "g_SCS",           # Multiple testing correction (g:Profiler default)
  sources = c("GO:BP"),                  # Test only Gene Ontology Biological Processes
  domain_scope = "annotated"             # Use all annotated genes as background
)

# Extract results table
tabla <- gost_liver$result 

# Create Manhattan plot of enrichment results
p <- gostplot(gostres = gost_liver, 
              capped = TRUE,                 # Cap very small p-values for visualization
              interactive = FALSE) +
     ylim(0, 4)                              # Limit y-axis range

# Highlight specific terms of interest in the plot
pp <- publish_gostplot(
  p,
  highlight_terms = c("GO:0032805", "GO:0006790"),
  width = NA,
  height = NA
) 

```

Over-representation analysis using `g:Profiler2` identified two significantly enriched Gene Ontology Biological Process terms among the 63 liver DEGs (Method 1, FDR < 0.01, |log₂FC| > 1). The most significant enrichment was for positive regulation of low-density lipoprotein particle receptor catabolic process (GO:0032805, p = 1.7×10⁻², 3 genes), directly implicating lipoprotein receptor regulation in the transcriptional response. 

The second enriched term was sulfur compound metabolic process (GO:0006790, p = 4.5×10⁻², 323 genes), a broad metabolic category that may reflect secondary metabolic remodeling following altered lipid handling. While this enrichment is less specific, it suggests that ApoE isoform conversion triggers broader metabolic adaptations beyond lipid metabolism alone.  

The limited number of significantly enriched terms in ORA likely reflects the modest size of the high-confidence DEG list (63 genes after stringent filtering), which reduces statistical power to detect over-representation in narrowly defined functional categories. This motivated the use of Gene Set Enrichment Analysis as a complementary approach that leverages information from all genes rather than only those passing significance thresholds.

### Gene Set Enrichment Analysis (GSEA)
Gene Set Enrichment Analysis (GSEA) using the complete ranked gene list identified five significantly enriched pathways (FDR < 0.01), all related to mitochondrial oxidative metabolism:

```{r}
#| fig-width: 10


#################################################################
### Mouse Gene Sets from MSigDB #################################
### https://www.gsea-msigdb.org/gsea/msigdb/mouse/genesets.jsp ##
#################################################################

set.seed(42)  # Set seed for reproducibility

# Load complete differential expression results (all genes, not just significant)
liver <- read_csv("data/results_liver_1.csv")

# Create ranked gene list based on log2 fold change
# GSEA uses the ranking of ALL genes, not just significant ones
gene_ranks <- liver$log2FoldChange
names(gene_ranks) <- liver$gene
gene_ranks <- sort(gene_ranks, decreasing = TRUE)  # Sort high to low

# Retrieve Gene Ontology Biological Process gene sets from MSigDB
# MSigDB Collection M5 = ontology gene sets
# Subcollection BP = Biological Process
gene_sets <- msigdbr(
  species = "Mus musculus",      # Mouse
  db_species = "MM",              # Mouse species code
  collection = "M5",              # GO gene sets
  subcollection = "BP"            # Biological Process ontology
)

# Convert to list format required by fgsea
# Each element = one gene set (pathway) with its member genes
gene_sets_list <- split(gene_sets$gene_symbol, gene_sets$gs_name)

# Run Fast Gene Set Enrichment Analysis
# Tests whether genes in each pathway are randomly distributed in the ranked list
# or concentrated at the top (upregulated) or bottom (downregulated)
fgsea_results <- fgsea(
  pathways = gene_sets_list,      # Gene sets to test
  stats = gene_ranks,             # Ranked gene list
  eps = 0.0,                      # Precision for p-value estimation (0 = exact)
  minSize = 15,                   # Minimum genes per pathway
  maxSize = 500                   # Maximum genes per pathway
)

# Filter and format results
gsea <- fgsea_results |> 
  arrange(padj) |>                      # Sort by adjusted p-value
  filter(padj < 0.05) |>                # Keep only significant pathways
  select(-leadingEdge) |>                # Remove gene list column for display
  arrange(desc(NES))                     # Sort by normalized enrichment score
# Display results table
kbl(gsea |> select(pathway, NES, padj, size),
  digits = 3) |>
  kable_styling(full_width = FALSE, "striped")
```

Notably, all five pathways exhibited positive enrichment scores, indicating coordinated upregulation of genes involved in these processes following ApoE4→ApoE2 conversion. The enrichment plot for proton motive force-driven ATP synthesis illustrated that genes in this pathway were strongly concentrated among highly upregulated genes, with peak enrichment occurring within the top ~25% of ranked genes. This distribution pattern indicates genuine coordinated regulation rather than random association.

#### APOE2 Enhances Mitochondrial ATP Production{.unnumbered}
```{r}
#| fig-height: 4
plotEnrichment(gene_sets_list[["GOBP_PROTON_MOTIVE_FORCE_DRIVEN_ATP_SYNTHESIS"]], 
               gene_ranks) +
  labs(title = "GO:BP Proton Motive Force Driven ATP Synthesis",
       subtitle = "NES = 2.15, padj = 0.0025")
```

The convergent enrichment of multiple interconnected mitochondrial pathways—respiratory chain complex assembly (which builds the electron transport chain), NADH dehydrogenase complex assembly (Complex I assembly specifically), proton motive force-driven ATP synthesis (ATP synthase function), and oxidative phosphorylation (the overall process)—suggests a coherent biological program. Specifically, these findings indicate that ApoE2 expression enhances mitochondrial bioenergetic capacity compared to ApoE4 expression in hepatocytes.

The inclusion of "translation at synapse" among enriched pathways was unexpected in a liver tissue analysis, as this term typically applies to neuronal tissues. This likely represents either: (1) annotation artifacts where genes involved in general translational machinery are also annotated to synapse-specific processes, or (2) genuine enrichment of ribosomal/translational components that support increased protein synthesis for mitochondrial biogenesis

## Brain

### Over-Representation Analysis (ORA)

Over-representation analysis of the 69 brain DEGs (Method 1, FDR < 0.01, |log₂FC| > 1) identified ten significantly enriched Gene Ontology terms spanning multiple functional domains. Unlike the liver, where enrichment centered on lipoprotein metabolism, the brain showed a diverse functional landscape.

This heterogeneous enrichment pattern suggests that the transcriptional response to ApoE4→ApoE2 conversion in brain affects multiple distinct biological systems rather than a single coherent pathway. The prominence of neuroendocrine-related terms (neurohypophyseal hormone activity, vasopressin receptor binding, maternal aggressive behavior) is particularly notable and may reflect effects on hypothalamic-pituitary signaling. The enrichment of basic metabolic pathways (glycolysis, amino acid biosynthesis) alongside behavioral and neuroendocrine terms suggests broad metabolic and functional remodeling in response to ApoE isoform switching.

```{r}
#| fig-width: 10
#| fig-height: 7
#| out-width: "100%"

# Load clean DEGs from method 1 for the brain
# Sort by absolute fold change to prioritize genes with largest effect sizes
results_brain <- read_csv("data/clean_DEGs_brain_1.csv") |> 
  arrange(desc(abs(log2FoldChange)))

# Perform over-representation analysis using g:Profiler
# Tests whether DEGs are enriched in functional categories compared to background
gost_brain <- gost(
  query = results_brain$gene,           # List of significant DEGs
  organism = "mmusculus",                # Mouse
  ordered_query = TRUE,                  # Preserve gene ranking by fold change
  exclude_iea = FALSE,                   # Include electronically inferred annotations
  user_threshold = 0.05,                 # Significance threshold
  significant = TRUE,                    # Return only significant terms
  correction_method = "g_SCS",           # Multiple testing correction (g:Profiler default)
  #sources = c("GO:BP"),                  # Test only Gene Ontology Biological Processes
  domain_scope = "annotated"             # Use all annotated genes as background
)

# Extract results table
tabla_brain <- gost_brain$result 

# Create Manhattan plot of enrichment results
p <- gostplot(gostres = gost_brain, 
              capped = TRUE,                 # Cap very small p-values for visualization
              interactive = FALSE) +
     ylim(0, 4)                              # Limit y-axis range

# Highlight specific terms of interest in the plot
pp <- publish_gostplot(
  p,
  highlight_terms = gost_brain$result$term_id,
  width = NA,
  height = NA
) 

```



### Gene Set Enrichment Analysis (GSEA)

GSEA of brain tissue revealed seventeen significantly enriched pathways (FDR < 0.05), predominantly related to chromatin regulation, neuronal structure, and gene expression control:

```{r}
#| fig-width: 10
#| fig-height: 7


#################################################################
### Mouse Gene Sets from MSigDB #################################
### https://www.gsea-msigdb.org/gsea/msigdb/mouse/genesets.jsp ##
#################################################################

set.seed(42)  # Set seed for reproducibility

# Load complete differential expression results (all genes, not just significant)
brain <- read_csv("data/results_brain_1.csv")

# Create ranked gene list based on log2 fold change
# GSEA uses the ranking of ALL genes, not just significant ones
gene_ranks <- brain$log2FoldChange
names(gene_ranks) <- brain$gene
gene_ranks <- sort(gene_ranks, decreasing = TRUE)  # Sort high to low

# Retrieve Gene Ontology Biological Process gene sets from MSigDB
# MSigDB Collection M5 = ontology gene sets
# Subcollection BP = Biological Process
gene_sets <- msigdbr(
  species = "Mus musculus",      # Mouse
  db_species = "MM",              # Mouse species code
  collection = "M5",              # GO gene sets
  subcollection = "BP"            # Biological Process ontology
)

# Convert to list format required by fgsea
# Each element = one gene set (pathway) with its member genes
gene_sets_list <- split(gene_sets$gene_symbol, gene_sets$gs_name)

# Run Fast Gene Set Enrichment Analysis
# Tests whether genes in each pathway are randomly distributed in the ranked list
# or concentrated at the top (upregulated) or bottom (downregulated)
fgsea_results <- fgsea(
  pathways = gene_sets_list,      # Gene sets to test
  stats = gene_ranks,             # Ranked gene list
  eps = 0.0,                      # Precision for p-value estimation (0 = exact)
  minSize = 15,                   # Minimum genes per pathway
  maxSize = 500                   # Maximum genes per pathway
)



# Filter and format results
gsea <- fgsea_results |> 
  arrange(padj) |>                      # Sort by adjusted p-value
  filter(padj < 0.05) |>                # Keep only significant pathways
  arrange(desc(NES))                     # Sort by normalized enrichment score



# Display results table
kbl(gsea |> select(pathway, NES, padj, size),
  digits = 3) |>
  kable_styling(full_width = FALSE, "striped")
```

All pathways exhibited positive enrichment scores, indicating coordinated upregulation of genes in these functional categories following ApoE4→ApoE2 conversion. The enrichment pattern in brain contrasts markedly with liver, where mitochondrial oxidative metabolism dominated. Instead, brain tissue shows coordinated changes in three major functional domains: (1) chromatin organization and epigenetic regulation, suggesting remodeling of gene expression programs; (2) cytochrome P450-mediated metabolism of arachidonic acid and xenobiotics, implicating changes in lipid mediator synthesis and detoxification capacity; and (3) neuronal structural plasticity and synaptic organization, indicating potential effects on neural circuit architecture.

#### Visualizing Leading Edge Gene Overlaps with UpSet Plot


To understand the relationships between enriched pathways and identify genes contributing to multiple functional categories, we visualized the overlap of leading-edge genes across the significantly enriched brain pathways using an UpSet plot. Leading-edge genes are those contributing most strongly to each pathway's enrichment signal (the subset of genes appearing before the peak enrichment score in the GSEA running sum).

The UpSet plot revealed extensive sharing of leading-edge genes across pathways, with many genes contributing to multiple functional categories simultaneously. The largest unique gene set (approximately 100 genes) was specific to chromatin remodeling, indicating a substantial group of genes uniquely involved in epigenetic regulation. However, numerous genes appeared in multiple pathway intersections


```{r}
#| column: page
#| fig-width: 14
#| fig-height: 7


leadingEdge <- gsea$leadingEdge |> 
  set_names(gsea$pathway)


# Create UpSet plot
upset(fromList(leadingEdge), 
      order.by = "freq",
      nsets = length(leadingEdge),
      nintersects = 30,
      empty.intersections = "on")


```

#### Reducing Redundant Pathways with `collapsePathways`


Given the extensive overlap in leading-edge genes between pathways, we applied the `collapsePathways` function from the `fgsea` package to reduce redundancy and identify independent biological themes. This analysis groups pathways with highly similar gene membership, retaining only the most significantly enriched representative from each cluster.


```{r}

# Subset gene_sets_list to only include significant pathways
gene_sets_significant <- gene_sets_list[gsea$pathway]


# Step 3: Run collapsePathways
# This identifies redundant pathways based on leading edge overlap
collapsed <- collapsePathways(
  fgseaRes = fgsea_results |> filter(padj<0.05),     # Your fgsea results (filtered)
  pathways = gene_sets_significant,     # Gene sets (filtered to significant)
  pval.threshold = 0.01,               # P-value threshold for significance
  stats = gene_ranks                    # Same ranked gene list used in fgsea
)

# Step 4: Extract the main (representative) pathways
main_pathways <- collapsed$mainPathways

# Step 5: Filter your results to keep only main pathways
gsea_collapsed <- fgsea_results |> 
  filter(padj<0.05) |>
  filter(pathway %in% main_pathways) |>
  arrange(desc(NES))

# View how many pathways were collapsed
cat("Original significant pathways:", nrow(gsea), "\n")
cat("After collapsing:", nrow(gsea_collapsed), "\n")

# Display results table
kbl(gsea_collapsed |> select(pathway, NES, padj, size),
  digits = 3) |>
  kable_styling(full_width = FALSE, "striped")

```

**Collapsed pathways** (redundant with retained representatives):
- Multiple chromatin-related terms collapsed into "regulation of chromatin organization" and "chromatin remodeling"
- Several mRNA metabolism terms collapsed into "regulation of mRNA metabolic process" and "mRNA processing"
- Various dendritic and synaptic terms collapsed into "dendrite development," "synapse assembly," and "regulation of synapse structure or activity"
- Xenobiotic-related pathways (epoxygenase P450, arachidonic acid metabolism, cellular response to xenobiotic stimulus) collapsed into "xenobiotic metabolic process"

This collapsed set of eleven pathways provides a clearer, non-redundant summary of the brain's transcriptional response while preserving all major biological themes. The analysis confirms that the brain response encompasses four primary functional domains:

1. **Epigenetic regulation** (chromatin organization and remodeling) - 2 pathways
2. **RNA processing and metabolism** (splicing and mRNA regulation) - 2 pathways  
3. **Neuronal structure and function** (dendrite development, synapse assembly/regulation, action potential) - 4 pathways
4. **Metabolic processes** (xenobiotic metabolism, uronic acid metabolism) - 2 pathways
5. **Specialized metabolism** (uronic acid, a component of glycosaminoglycans important for extracellular matrix) - 1 pathway

The retention of both "chromatin organization" and "chromatin remodeling" as independent pathways despite their conceptual similarity suggests these represent distinct aspects of epigenetic regulation (organizational state versus active remodeling machinery). Similarly, the preservation of multiple synaptic/dendritic pathways indicates genuine enrichment across different aspects of neuronal structural plasticity rather than redundant detection of the same underlying biology.

This pathway reduction analysis strengthens confidence in the original findings by demonstrating that the breadth of enriched pathways reflects genuine biological diversity in the brain's response rather than statistical artifacts arising from pathway overlap in gene set databases.